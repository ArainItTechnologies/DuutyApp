name: CI - Build & Test

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/*.sln', '**/*.csproj', 'nuget.config') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Locate solution file
        id: find_sln
        run: |
          set -e
          sln=$(git ls-files '*.sln' | head -n1 || true)
          if [ -z "$sln" ]; then
            sln=$(find . -maxdepth 4 -name '*.sln' | head -n1 || true)
          fi
          if [ -z "$sln" ]; then
            echo "No .sln file found in repository (searched git index and up to 4 levels)."
            exit 1
          fi
          echo "solution=$sln" >> $GITHUB_OUTPUT

      - name: Nuget Restore
        run: |
          set -o pipefail
          echo "Restoring solution: ${{ steps.find_sln.outputs.solution }}"
          # show NuGet config if present for debugging
          if [ -f nuget.config ]; then
            echo "Found nuget.config:"
            sed -n '1,200p' nuget.config || true
          fi
          # run restore and capture full verbose logs
          dotnet restore "${{ steps.find_sln.outputs.solution }}" -v diag
        shell: bash

      - name: Dotnet Build
        run: dotnet build "${{ steps.find_sln.outputs.solution }}" -c Release --no-restore

      - name: Dotnet Test
        run: dotnet test "${{ steps.find_sln.outputs.solution }}" -c Release --no-build --logger "trx;LogFileName=test_results.trx"

      - name: Publish API (Duuty.Server)
        if: success()
        run: |
          dotnet publish src/Duuty.Server -c Release -o ./artifacts/Duuty.Server --no-build

      - name: Upload published artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: published
          path: ./artifacts

  deploy:
    name: Deploy to Azure App Service
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && success()
    steps:
      - name: Download published artifact
        uses: actions/download-artifact@v4
        with:
          name: published
          path: ./artifacts

      - name: Prepare package
        run: |
          set -e
          # create a zip from the published output for deployment
          cd artifacts
          if [ -d "Duuty.Server" ]; then
            zip -r duuty-server.zip Duuty.Server
          else
            echo "Published folder not found: artifacts/Duuty.Server"
            ls -la
            exit 1
          fi
        shell: bash

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v2
        with:
          app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          package: ./artifacts/duuty-server.zip